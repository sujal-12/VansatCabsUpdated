<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Start Trip</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: #333;
        }

        #map {
            width: 100%;
            height: 70vh;
            background-color: #e0e0e0;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            margin-top: 0;
        }

        .main-content {
            min-height: 30vh;
            max-height: 30vh;
            padding: 20px;
            background-color: #f8f8f8;
            max-width: 420px;
            width: 100%;
            margin: 0 auto;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            margin-top: -50px;
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 90px;
            overflow-y: hidden;
        }

        .ride-card {
            background-color: #fff;
            border-radius: 12px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .driver-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        .driver-details {
            display: flex;
            align-items: center;
            gap: 0px;
            flex-grow: 1;
        }

        .driver-name-and-contact {
            display: flex;
            flex-direction: row;
            align-items: center;
            line-height: 1.3;
            gap: 15px;
            flex-wrap: wrap;
        }

        .driver-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .toggle-icon {
            display: none;
        }

        .trip-details-collapsed {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: visible;
            max-height: none;
        }

        .location-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.95em;
            color: #555;
        }

        .location-icon-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            font-size: 0.8em;
            margin-top: 2px;
        }

        .location-icon-marker.pickup {
            background-color: #e6f7ed;
            color: #55b77e;
        }

        .location-icon-marker.destination {
            background-color: #f7e6e6;
            color: #e74c3c;
        }

        .location-icon-marker.phone {
            background-color: #e0f2f7;
            color: #3498db;
        }

        .location-details {
            flex-grow: 1;
        }

        .location-address strong {
            font-weight: 600;
            color: #333;
            margin-right: 5px;
        }

        .action-button-container {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
            background-color: #f8f8f8;
            padding: 15px 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .start-trip-button {
            flex-grow: 1;
            width: 100%;
            max-width: 360px;
            padding: 15px;
            background-color: #55b77e;
            color: black;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .start-trip-button:hover {
            background-color: #4ca873;
            transform: translateY(-1px);
        }

        .start-trip-button:active {
            transform: translateY(0);
        }

        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #55b77e;
            color: black;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            font-weight: 500;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }

        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

        .message-box.error {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    {# Load the static files app #}
    {% load static %}

    <div id="map"></div>
    <div class="main-content">
        <div class="ride-card">
            <div class="driver-info" id="driverInfoToggle">
                <div class="driver-details">
                    <div class="driver-name-and-contact">
                        <span class="driver-name">{{ driver.drivername }}</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" id="toggleArrow"></i>
            </div>
            {% if assigned_trip %}
            <div class="trip-details-collapsed" id="tripDetailsSection">
                <div class="location-item">
                    <div class="location-icon-marker pickup"><i class="fa-solid fa-location-dot"></i></div>
                    <div class="location-details">
                        <span class="location-address"><strong>From:</strong> {{ assigned_trip.from_city }}</span>
                    </div>
                </div>
                <div class="location-item">
                    <div class="location-icon-marker destination"><i class="fa-solid fa-map-pin"></i></div>
                    <div class="location-details">
                        <span class="location-address"><strong>To:</strong> {{ assigned_trip.to_city }}</span>
                    </div>
                </div>
                <div class="location-item">
                    <div class="location-icon-marker phone"><i class="fa-solid fa-phone"></i></div>
                    <div class="location-details">
                        <span class="location-address"><strong>Contact:</strong> {{ assigned_trip.contact_number|default:"N/A" }}</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="trip-details-collapsed">
                <p>No trip assigned.</p>
            </div>
            {% endif %}
        </div>
        {% if assigned_trip and assigned_trip.status == 'Pending' %}
        <div class="action-button-container">
            <form method="post" style="width: 100%; display: flex; justify-content: center;">
                {% csrf_token %}
                <input type="hidden" name="action" value="start">
                <button type="submit" class="start-trip-button">Start Trip</button>
            </form>
        </div>
        {% endif %}
    </div>
    <div id="floatingMessage" class="message-box">Trip Started!</div>

    <script>
        let map;
        let driverMarker;
        let directionsService;
        let directionsRenderer;
        let watchId;

        function initMap() {
            console.log('initMap called');

            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 20.5937, lng: 78.9629 },
                zoom: 5,
                disableDefaultUI: true,
                zoomControl: false,
                streetViewControl: false,
                mapTypeControl: false,
                fullscreenControl: false,
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "all",
                        "stylers": [
                            { "saturation": -100 },
                            { "lightness": -10 }
                        ]
                    }
                ]
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                polylineOptions: {
                    strokeColor: '#55b77e',
                    strokeWeight: 5
                },
                suppressMarkers: true
            });
            directionsRenderer.setMap(map);

            // Define the car image icon using the Django static URL
            const carImageIcon = {
                url: "{% static 'images/carlogo.png' %}", // IMPORTANT: Adjust path to your image
                scaledSize: new google.maps.Size(40, 40), // Adjust size as needed
                anchor: new google.maps.Point(20, 20) // Anchor point for centering (half of scaledSize)
            };

            driverMarker = new google.maps.Marker({
                map: map,
                icon: carImageIcon,
                title: 'Your Vehicle'
            });

            // Start tracking live location
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        driverMarker.setPosition(pos);
                        map.setCenter(pos);
                        map.setZoom(15);
                        showMessage('Live location updated', false);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        showMessage('Unable to access location. Please enable location services.', true);
                        map.setCenter({ lat: 20.5937, lng: 78.9629 });
                        map.setZoom(5);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showMessage('Geolocation is not supported by this browser.', true);
            }

            {% if assigned_trip %}
            const fromCity = "{{ assigned_trip.from_city|escapejs }}";
            const toCity = "{{ assigned_trip.to_city|escapejs }}";
            calculateAndDisplayRoute(fromCity, toCity);

            const geocoder = new google.maps.Geocoder();
            const pickupIcon = {
                path: 'M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z',
                fillColor: '#55b77e',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 2,
                scale: 1.5,
                anchor: new google.maps.Point(12, 24)
            };
            geocoder.geocode({ address: fromCity }, function (results, status) {
                if (status === "OK" && results[0]) {
                    new google.maps.Marker({
                        position: results[0].geometry.location,
                        map: map,
                        icon: pickupIcon,
                        title: 'Pickup Location'
                    });
                } else {
                    showMessage('Failed to geocode pickup location.', true);
                }
            });

            const destinationIcon = {
                path: 'M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z',
                fillColor: '#e74c3c',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 2,
                scale: 1.5,
                anchor: new google.maps.Point(12, 24)
            };
            geocoder.geocode({ address: toCity }, function (results, status) {
                if (status === "OK" && results[0]) {
                    new google.maps.Marker({
                        position: results[0].geometry.location,
                        map: map,
                        icon: destinationIcon,
                        title: 'Destination Location'
                    });
                } else {
                    showMessage('Failed to geocode destination location.', true);
                }
            });
            {% endif %}
        }

        function calculateAndDisplayRoute(from, to) {
            directionsService.route({
                origin: from,
                destination: to,
                travelMode: google.maps.TravelMode.DRIVING
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                } else {
                    console.error('Directions request failed due to ' + status);
                    showMessage('Could not load trip route. Please check your API key and enabled APIs.', true);
                }
            });
        }

        function showMessage(message, isError = false) {
            const floatingMessage = document.getElementById('floatingMessage');
            floatingMessage.textContent = message;
            floatingMessage.classList.toggle('error', isError);
            floatingMessage.classList.add('show');
            setTimeout(() => {
                floatingMessage.classList.remove('show');
                floatingMessage.classList.remove('error');
            }, 2000);
        }

        window.addEventListener('unload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });

        window.addEventListener('load', () => {
            if (!window.google || !window.google.maps) {
                showMessage('Google Maps failed to load. Please check your API key and internet connection.', true);
            }
        });
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8K8LRL9aOacWYYxIQn1YyeaJQVRzJqvM&callback=initMap&libraries=places">
    </script>
</body>
</html>