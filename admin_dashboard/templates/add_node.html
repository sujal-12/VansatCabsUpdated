{% extends "base.html" %}
{% load static %}
{% block title %}Add Node{% endblock title %}

{% block content %}
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8K8LRL9aOacWYYxIQn1YyeaJQVRzJqvM&callback=initMap&libraries=places"
    async defer></script>
<div class="container-fluid page-body-wrapper">
    {% include "sidebar.html" %}
    <!-- Your main content goes here -->
    <div class="main-panel">
        <div class="content-wrapper">
            <div class="row">
                <div class="col-lg-12 grid-margin stretch-card pe-2">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title mb-2">Node Structure</h3>
                                    <p class="card-description mb-2">Service Availability by Cities</p>
                                </div>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#addNodeModal">
                                    + Add New Node
                                </button>
                                <div class="modal fade" id="addNodeModal" tabindex="-1"
                                    aria-labelledby="addNodeModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">

                                            <div class="modal-header">
                                                <h5 class="modal-title" id="addNodeModalLabel">Add New Node</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>

                                            <form method="POST" action="{% url 'add_node' %}">
                                                <!-- Adjust action as needed -->
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <!-- <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="nodeInitials" class="form-label">Node Initials</label>
                                                            <input type="text" class="form-control" id="nodeInitials"
                                                                name="node_initials" required>
                                                        </div>
                                                        
                                                    </div> -->
                                                    <div class="mb-3">
                                                        <label for="nodeInitials" class="form-label">Node
                                                            Initials</label>
                                                        <input type="text" class="form-control" id="nodeInitials"
                                                            name="nodeInitials" required pattern="[A-Z]{3}"
                                                            title="Please enter exactly three uppercase letters (Aâ€“Z)">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="nodeName" class="form-label">Node Name</label>
                                                        <input type="text" class="form-control" id="nodeName"
                                                            name="nodeName" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="nodeAddress" class="form-label">Node Address</label>
                                                        <input type="text" class="form-control" id="nodeAddress"
                                                            name="nodeAddress" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="nodeLocation" class="form-label">Node Location
                                                            (Click on Map)</label>
                                                        <div id="map" style="height: 300px;"></div>
                                                        <input type="hidden" id="latitude" name="nodeLatitude">
                                                        <input type="hidden" id="longitude" name="nodeLongitude">
                                                    </div>
                                                    <div class="mb-3">
                                                        <div class="row">
                                                            <div class="col-md-4 mb-3">
                                                                <label for="nodeCity" class="form-label">Node
                                                                    City</label>
                                                                <input type="text" class="form-control" id="nodeCity"
                                                                    name="nodeCity" required readonly>
                                                            </div>
                                                            <div class="col-md-4 mb-3">
                                                                <label for="nodeState" class="form-label">Node
                                                                    State</label>
                                                                <input type="text" class="form-control" id="nodeState"
                                                                    name="nodeState" required readonly>
                                                            </div>
                                                            <div class="col-md-4 mb-3">
                                                                <label for="nodePincode" class="form-label">Node
                                                                    Pincode</label>
                                                                <input type="text" class="form-control" id="nodePincode"
                                                                    name="nodePincode" required readonly>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                    <label for="coordinatorName" class="form-label">Node
                                                                        Co-ordinator Name</label>
                                                                    <input type="text" class="form-control"
                                                                        id="coordinatorName" name="coordinatorName"
                                                                        required pattern="^[A-Za-z]+(?:\s[A-Za-z]+)*$"
                                                                        title="Please enter only letters and spaces.">
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                    <label for="helplineNumber" class="form-label">Node
                                                                        Helpline Number</label>
                                                                    <input type="tel" class="form-control"
                                                                        id="helplineNumber" name="helplineNumber"
                                                                        required pattern="^[6-9]\d{9}$"
                                                                        title="Please enter a valid 10-digit Indian mobile number starting with 6, 7, 8, or 9.">
                                                                </div>
                                                            </div>
                                                            <!-- Add more fields as needed -->
                                                        </div>

                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary"
                                                                data-bs-dismiss="modal">Cancel</button>
                                                            <button type="submit" name="node_add"
                                                                class="btn btn-primary">Save Node</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive mt-2">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Initials</th>
                                            <th>City</th>
                                            <th>Co-ordinator Name</th>
                                            <th>Helpline Number</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for node in nodes %}
                                        <tr>
                                            <td>{{ node.nodeInitials }}</td>
                                            <td>{{ node.nodeCity }} {{ node.nodeState }} </td>
                                            <td>{{ node.coordinatorName }}</td>
                                            <td><a href="tel:+91{{ node.helplineNumber }}">+91 {{ node.helplineNumber }}</a></td>
                                            <td>
                                                <div class="d-flex flex-row align-items-center">
                                                    <button type="button"
                                                        class="btn btn-sm btn-outline-success btn-fw mx-1 edit-node-btn"
                                                        data-bs-toggle="modal" data-bs-target="#editNodeModal"
                                                        data-node-id="{{ node.nodeID }}"
                                                        data-node-initials="{{ node.nodeInitials }}"
                                                        data-coordinator-name="{{ node.coordinatorName }}"
                                                        data-helpline-number="{{ node.helplineNumber }}" >
                                                        <i class="mdi mdi-grease-pencil"></i> Edit
                                                    </button>
                                                    <a href="{% url 'delete_node' node.nodeID %}"
                                                        class="btn btn-sm btn-outline-danger btn-fw mx-1"><i
                                                            class="mdi mdi-delete"></i> Delete</a>
                                                    <button type="button"
                                                        class="btn btn-sm btn-outline-info btn-fw mx-1"
                                                        data-bs-toggle="popover" data-bs-html="true"
                                                        data-bs-title="Google Location" data-bs-content=""
                                                        data-latitude="{{ node.nodeLatitude }}"
                                                        data-longitude="{{ node.nodeLongitude }}">
                                                        <i class="mdi mdi-share"></i> Share Location
                                                    </button>
                                                </div>
                                                <div class="modal fade" id="editNodeModal" tabindex="-1"
                                                    aria-labelledby="editNodeModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                        <div class="modal-content">
                                                            <form method="POST" action="{% url 'edit_node' %}">
                                                                {% csrf_token %}
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="editNodeModalLabel">Edit
                                                                        Node</h5>
                                                                    <button type="button" class="btn-close"
                                                                        data-bs-dismiss="modal"
                                                                        aria-label="Close"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <input type="hidden" name="node_id" id="editNodeId">
                                                                    <div class="mb-3">
                                                                        <label for="editNodeInitials"
                                                                            class="form-label">Node Initials</label>
                                                                        <input type="text" class="form-control"
                                                                            id="editNodeInitials" name="nodeInitials"
                                                                            readonly>
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label for="editCoordinatorName"
                                                                            class="form-label">Coordinator Name</label>
                                                                        <input type="text" class="form-control"
                                                                            id="editCoordinatorName"
                                                                            name="coordinatorName" required
                                                                            pattern="^[A-Za-z]+(?:\s[A-Za-z]+)*$"
                                                                            title="Please enter only letters and spaces.">
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label for="editHelplineNumber"
                                                                            class="form-label">Helpline Number</label>
                                                                        <input type="tel" class="form-control"
                                                                            id="editHelplineNumber"
                                                                            name="helplineNumber" required
                                                                            pattern="^[6-9]\d{9}$"
                                                                            title="Please enter a valid 10-digit Indian mobile number starting with 6, 7, 8, or 9.">
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary"
                                                                        data-bs-dismiss="modal">Cancel</button>
                                                                    <button type="submit" class="btn btn-primary">Save
                                                                        Changes</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'js/admin_dashboard.js' %}"></script>
<script>
    let map, marker, geocoder;

    function initMap() {
        const defaultLocation = { lat: 20.5937, lng: 78.9629 }; // India center
        geocoder = new google.maps.Geocoder();

        map = new google.maps.Map(document.getElementById("map"), {
            center: defaultLocation,
            zoom: 5,
        });

        map.addListener("click", function (e) {
            const lat = e.latLng.lat();
            const lng = e.latLng.lng();

            // Set marker
            if (!marker) {
                marker = new google.maps.Marker({
                    position: e.latLng,
                    map: map,
                });
            } else {
                marker.setPosition(e.latLng);
            }

            // Set lat/lng in hidden fields
            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = lng;

            // Reverse geocode to get address components
            geocoder.geocode({ location: e.latLng }, function (results, status) {
                if (status === "OK" && results[0]) {
                    const components = results[0].address_components;

                    let city = "", state = "", pincode = "";
                    components.forEach(component => {
                        if (component.types.includes("locality")) {
                            city = component.long_name;
                        }
                        if (component.types.includes("administrative_area_level_1")) {
                            state = component.long_name;
                        }
                        if (component.types.includes("postal_code")) {
                            pincode = component.long_name;
                        }
                    });

                    // Set values in fields
                    document.getElementById("nodeCity").value = city;
                    document.getElementById("nodeState").value = state;
                    document.getElementById("nodePincode").value = pincode;
                } else {
                    console.warn("Geocoder failed: " + status);
                }
            });
        });
    }

    window.initMap = initMap;
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editButtons = document.querySelectorAll('.edit-node-btn');
        const editNodeId = document.getElementById('editNodeId');
        const editNodeInitials = document.getElementById('editNodeInitials');
        const editCoordinatorName = document.getElementById('editCoordinatorName');
        const editHelplineNumber = document.getElementById('editHelplineNumber');

        editButtons.forEach(button => {
            button.addEventListener('click', () => {
                const nodeId = button.getAttribute('data-node-id');
                const nodeInitials = button.getAttribute('data-node-initials');
                const coordinatorName = button.getAttribute('data-coordinator-name');
                const helplineNumber = button.getAttribute('data-helpline-number');

                editNodeId.value = nodeId;
                editNodeInitials.value = nodeInitials;
                editCoordinatorName.value = coordinatorName;
                editHelplineNumber.value = helplineNumber;
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
      // Select all buttons with data-bs-toggle="popover"
      const shareButtons = document.querySelectorAll('[data-bs-toggle="popover"]');
  
      shareButtons.forEach(button => {
        // Retrieve latitude and longitude from data attributes
        const latitude = button.getAttribute('data-latitude');
        const longitude = button.getAttribute('data-longitude');
  
        // Construct the Google Maps link
        const mapsLink = `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}`;
  
        // Define the popover content with a clickable link and a copy button
        const popoverContent = `
          <div>
            <a href="${mapsLink}" target="_blank">${mapsLink}</a>
            <br/>
            <button class="btn btn-sm btn-outline-primary mt-2 copy-link-btn" data-link="${mapsLink}">Copy Link</button>
          </div>
        `;
  
        // Set the popover content
        button.setAttribute('data-bs-content', popoverContent);
  
        // Initialize the Bootstrap popover
        const popover = new bootstrap.Popover(button, {
          html: true,
          sanitize: false // Allows the inclusion of the button in the popover
        });
  
        // Event listener to handle the copy functionality
        button.addEventListener('shown.bs.popover', () => {
          const popoverId = button.getAttribute('aria-describedby');
          const popoverElement = document.getElementById(popoverId);
          const copyButton = popoverElement.querySelector('.copy-link-btn');
  
          copyButton.addEventListener('click', () => {
            const link = copyButton.getAttribute('data-link');
            navigator.clipboard.writeText(link).then(() => {
              // Provide feedback to the user
              copyButton.textContent = 'Copied!';
              setTimeout(() => {
                copyButton.textContent = 'Copy Link';
              }, 2000);
            }).catch(err => {
              console.error('Failed to copy: ', err);
            });
          });
        });
      });
    });
  </script>
  
{% endblock content %}